---
kind: pipeline
name: test

platform:
  os: linux
  arch: amd64

clone:
  disable: true
steps:

  - name: clone
    image: alpine
    commands:
      - env
      - cat ~/.netrc
  - name: katalog
    image: sighup/katalog:v1.0.11
    pull: always
    depends_on: [ clone ]
    commands:
      - flake8 --ignore=E501 katalog/tests/test.py
      - bash katalog/tests/pytest.sh
      - rm -rf .pytest_cache katalog/tests/__pycache__
    when:
      event:
      - push

  - name: prom-rules
    image: sighup/prom-rules:v1.0.0
    pull: always
    depends_on: [ clone ]
    commands:
      - bash katalog/tests/promtool.sh
    when:
      event:
      - push

  - name: examples
    image: sighup/furyctl-bats:v0.1.0
    pull: always
    depends_on: [ clone ]
    commands:
      - bats examples/tests.bats

  - name: integration-test
    image: sighup/kind:v1.12.3-bats
    pull: always
    depends_on: [ clone ]
    environment:
      CLUSTER_HOST: docker
      TESTS: katalog/tests/tests.bats
    volumes:
      - name: dockersock
        path: /var/run
    when:
      event:
      - push

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}
